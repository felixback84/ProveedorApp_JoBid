var parseSimpleCSV = function(data, groupBy, replacements) {
  if (replacements && !groupBy) {
    throw "You cannot use replacements unless group by is specified";
  }
  var count = 0;
  var rows
  if (groupBy) {
    rows = {};
    if (replacements && replacements[groupBy] ) {
      groupBy = replacements[groupBy];
    }
  } else {
    rows = [];
  }
  var saferData = data.replace(/\r?\n|\r/g, '\n');
  var lines = saferData.split('\n');
  var headers = lines[0].split(',');
  for (var i=1; i<lines.length; i++) {
    var parts = lines[i].split(',');
    if (parts.length>1) {
      count += 1;
      var row = {};
      for (var j=0; j<headers.length; j++) {
        var key = headers[j];
        if (replacements && replacements[key]) {
          key = replacements[key];
        }
        row[key] = parts[j];
      }
      if (groupBy) {
        if (rows[row[groupBy]]) {
          console.error('Existing row', row[groupBy]);
        } else {
          rows[row[groupBy]] = row;
        }
      } else {
        rows.push(row);
      }
    }
  }
  var res = {
    headers: headers,
    rows: rows,
    count: count
  }
  // console.log(res.rows);
  // console.log(res.rows[0]);
  // console.log(res.rows[res.count-1]);
  return res;
};

module.exports = parseSimpleCSV;
